name: Build compressed JSON files

on:
  push:
    paths:
      - 'cards/*.json'
      - '!cards/*.min.json'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build compressed JSON files
        run: |
          mkdir -p cards

          for file in cards/*.json; do
            # Skip .min.json files
            if [[ "$file" == *.min.json ]]; then
              continue
            fi

            base="${file%.json}"
            compiled="$base.compiled.json"
            gz="$compiled.gz"

            echo "â†’ Processing $file"
            echo "   Minified: $compiled"
            echo "   Gzipped : $gz"

            # Minify
            jq -c . "$file" > "$compiled"

            # Gzip (force overwrite)
            gzip -c "$compiled" > "$gz"
          done

      - name: Commit compiled and gzipped JSON
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Auto-build JSON compiled and gzipped"
          file_pattern: cards/*.compiled.json cards/*.compiled.json.gz
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
